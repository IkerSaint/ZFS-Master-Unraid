Menu="Main:2"
Title="ZFS Master"
Tag="database"
Cond="file_exists('/usr/sbin/zpool')"
Nchan="zfs_master"
---
<?php
$plugin = "zfs.master";
$docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';

require_once $docroot."/plugins/".$plugin."/include/ZFSMBase.php";
require_once $docroot."/plugins/".$plugin."/include/ZFSMHelpers.php";

$zfsm_cfg = loadConfig(parse_plugin_cfg($plugin, true));
$zfsm_cfg['version'] = parse_ini_file('/etc/unraid-version')['version'];

$refreshbutton = '<span class="zfs_bar_button"><a style="cursor:pointer" class="tooltip" title="Refresh Information" onclick="refreshInfo()"><i id="zfsm-refresh" class="fa fa-refresh"></i></a></span>';
$settingsbutton = '<span class="zfs_bar_button"><a style="cursor:pointer" class="tooltip" title="ZFS Master Settings" href="/Settings/ZFSMasterSettings"><i id="zfsm-settings" class="fa fa-gear"></i></a></span>';

#$zpool_global = getZFSPools();
$zpool_global = array();
$zpool_devices = array();
$zpool_datasets = array();

foreach ($zpool_global as $zpool):
	$zpool_name = $zpool['Pool'];

	$zpool_devices[$zpool_name] = getZFSPoolDevices($zpool_name);
	$zpool_datasets[$zpool_name] = getZFSPoolDatasets($zpool_name, $zfsm_cfg['dataset_exclussion']);
	$zpool_global[$zpool_name]['Snapshots'] = $zpool_datasets[$zpool_name]['total_snapshots'];
	$zpool_global[$zpool_name]['MountPoint'] = $zpool_datasets[$zpool_name]['mountpoint'];
endforeach;

saveJSONToDisk($plugin_session_file, $zpool_datasets);

?>

<link type="text/css" rel="stylesheet" href="/webGui/styles/font-awesome.css?v=1545863026">

<style type="text/css">	
  .zfs_table td span{margin-left:10px}
  .zfs_table tr>td{width:auto!important}
  .zfs_table tr>td+td+td{text-align:left!important}
  .zfs_table tr>td+td+td+td+td+td+td+td{text-align:left!important}
  .zfs_table tr>td+td+td+td+td+td+td+td+td{text-align:center!important}
  
  .zfs_bar_button {
	  padding-right: 8px;
	  float: right;
  }
  
  .zfs_compact {
	  padding: 2px 4px 3px 6px!important;
	  margin: 2px 2px!important;
  }
  
</style>

<link type="text/css" rel="stylesheet" href="<?autov('/webGui/styles/jquery.ui.css')?>">

<script type="text/javascript" src="<?autov('/webGui/javascript/jquery.switchbutton.js')?>"></script>
<link type="text/css" rel="stylesheet" href="<?autov('/webGui/styles/jquery.switchbutton.css')?>">

<script type="text/javascript" src="<?autov('/plugins/zfs.master/assets/sweetalert2.all.min.js');?>"></script>
<link type="text/css" rel="stylesheet" href="<?autov('/plugins/zfs.master/assets/sweetalert2.min.css');?>">

<div id="zfs_master_div">
<table id="zfs_master" class="zfs_table disk_status wide">
  <thead>
    <tr>
	  <td>Pool</td>
	  <td>Health</td>
	  <td>Option/Dataset Name</td>
	  <td>Size</td>
	  <td>Mount Point</td>
	  <td>Refer</td>
	  <td>Used</td>
	  <td>Free</td>
	  <td>Snapshots</td>
	</tr>
  </thead>
  <tbody id="zfs_master_body">

  </tbody>
</table>
</div>

:zfs_master_help_plug:
> **ZFS Master.**
>
> ZPool Information Tool.
:end

<script type="text/javascript" src="<?autov('/plugins/zfs.master/frontend/ZFSMFrontEnd.js');?>"></script>

<script>

  <?if (exec("pgrep zfs_master")):?>

  var zfs_sub = new NchanSubscriber('/sub/zfs_master',{subscriber:'websocket'});

  zfs_sub.on('message', function(data) {
	if (data.op == "getAll") {
      createFullBodyTable(data, document);
	} else if (data.op == "") {

	}
  });

  <?else:?>

  <?endif;?>

  $(function() {
	  zfs_sub.start();
	  addButtons();
	  setInterval(function () { refreshInfo() }, <?=$zfsm_cfg['refresh_interval']?>*1000);
	  processHiddenDatasets();
  });

  $(document).click(function() {
	  removeContext();
  })
  
  function refreshInfo() {
	  replaceElementClass("#zfsm-refresh", "fa-refresh", "fa-spinner fa-spin");
	  
	  var $zfs_master = $("#zfs_master_div");
	  
	  $zfs_master.load("Main #zfs_master_div", function() {
		  replaceElementClass("#zfsm-refresh", "fa-spinner fa-spin", "fa-refresh");
		  processHiddenDatasets();
	  });
  }
  
  function replaceElementClass(element, oldClass, newClass){
	  $(element).removeClass(oldClass);
	  $(element).addClass(newClass);
  }
  
  function getUnraidParentElement() {
	  if ('<?=$zfsm_cfg['version']?>'.localeCompare('6.11.9', undefined, { numeric: true, sensitivity: 'base' }) == 1) {
		return $(".title .left").filter(function(){return $(this).text() === 'ZFS Master';}).parent();
	  }
	  return $("div#title > span.left").filter(function(){return $(this).text() === 'ZFS Master';}).parent();
  }
  
  function addButtons() {
	  var parent = getUnraidParentElement();
	  
	  parent.append('<?=$settingsbutton?>');
	  parent.append('<?=$refreshbutton?>');
  }
    
  function setCookie(key, value, daysToLive=365) {
	var expires = new Date();
	expires.setTime(expires.getTime() + (daysToLive * 24 * 60 * 60));
	document.cookie = key + '=' + value + ';expires=' + expires.toUTCString();
  }

  function getCookie(key) {
	var keyValue = document.cookie.match('(^|;) ?' + key + '=([^;]*)(;|$)');
	return keyValue ? keyValue[2] : null;
  }

  function eraseCookie(key) {
    var keyValue = getCookie(key);
    setCookie(key, keyValue, '-1');
  }

  function processHiddenDatasets() {
	var datasets = JSON.parse(getCookie('datasetsHidden'));
	
	if (datasets == null || datasets.length <= 0)
		return;

	for (let zdataset of datasets) {
		var myRows = document.getElementsByClassName(zdataset);
		
		for (let row of myRows) {
			$(row).hide(0);
			$('i[name=\''+zdataset+'\']').attr('class', 'fa fa-plus-square fa-append');
		} 
	}
  }

  function toggleDataset(zdataset) {
	var datasets = JSON.parse(getCookie('datasetsHidden'));
	var index = -1;

	if (datasets == null) {
		datasets = [];
	}

	var index = datasets.indexOf(zdataset);

	if (index > -1) {
		datasets.splice(index, 1);
	} else {
		datasets.push(zdataset);
	}

	var myRows = document.getElementsByClassName(zdataset);

	for (let row of myRows) {
		if (index == -1) {
			$(row).hide( "fast");
			$('i[name=\''+zdataset+'\']').attr('class', 'fa fa-plus-square fa-append');
		} else {
			$(row).show( "fast");
			$('i[name=\''+zdataset+'\']') .attr('class', 'fa fa-minus-square fa-append');
		}
	}

	setCookie('datasetsHidden', JSON.stringify(datasets));

	processHiddenDatasets();
  }
  
  function togglePoolTable(zpool_id, trclass) {
	var datasets = JSON.parse(getCookie('datasetsHidden'));
	var myArray = document.getElementsByClassName(trclass);
	var myButton = document.getElementById(zpool_id);
	var visibility = getCookie(trclass);

	if (datasets == null) {
		datasets = [];
	}

	for (let mytr of myArray) {
		if (visibility == "none") {
			var classList = $(mytr).attr('class').split(/\s+/);
			var cont = false;
			
			for (var i = 0; i < classList.length; i++) {
				if (datasets.indexOf(classList[i]) != -1) {
					cont = true;
					break;
				}
			}

			if (cont) {
				continue;
			}

			setCookie(trclass, 'table-row');	
			$(mytr).show("slow");
			myButton.firstChild.data = "Hide Datasets";
		} else {
			setCookie(trclass, 'none');	
			$(mytr).hide("slow");
			myButton.firstChild.data = "Show Datasets";
		}
	}
  }
  
  function createDataset(zpool) {
	  var csrf_token = $("input[name='csrf_token']").val();	  
	  openBox('<?=$urlcreatedataset?>?zpool='+zpool+'&csrf_token='+csrf_token,"Create Dataset",550,680,false);
  }

  function addDatasetContext(zpool, zdataset, snapscount, id, destructive_mode, encryption, origin) {
    var opts = [];

	if (destructive_mode != 0) {
		opts.push(
		  {
			text: _("Rename"),
			icon: "fa-font",
			action: function (e) {
				e.preventDefault();
				renameDataset(zdataset);
			}
		  },
		  {
			text: _("Edit Dataset"),
			icon: "fa-pencil",
			action: function (e) {
				e.preventDefault();
				editDataset(zpool, zdataset);
			}
		  },
		  {
			text: _("Destroy"),
			icon: "fa-trash",
			action: function (e) {
				e.preventDefault();
				destroyDataset(zdataset);
		    }
		  },
		  { divider: true }
		);
	}

    opts.push({
        text: _("Take Snapshot"),
        icon: "fa-camera-retro",
		action: function (e) {
			e.preventDefault();
			takeDatasetSnapshot(zdataset);
        },
    });
    
	if (encryption == 'available') {
		opts.push({
			text: _("Lock Dataset"),
			icon: "fa-lock",
			action: function(e) {
				e.preventDefault();
				lockDataset(zdataset);
			},
		});
	} else if (encryption == 'unavailable') {
		opts.push({
			text: _("Unlock Dataset"),
			icon: "fa-unlock",
			action: function(e) {
				e.preventDefault();
				unlockDataset(zdataset);
			},
		});
	}

	if (origin) {
		opts.push({
			text: _("Promote Dataset"),
			icon: "fa-upload",
			action: function(e) {
				e.preventDefault();
				promoteDataset(zdataset);
			},
		});
	}

	if (snapscount >= 1) {
        opts.push({
			text: _("Snapshots Admin"),
			icon: "fa-gears",
			action: function(e) {
				e.preventDefault();
				adminDatasetSnaps(zpool, zdataset);
			},
		});
    }

    context.attach("#" + id, opts);

	var father = document.getElementById(id).style;

	let height = $(`#dropdown-${id}`).height()
		$(`#dropdown-${id}`).css({
			position: 'absolute',
			top: father.pageY,
			left: father.pageX,
			display: 'block'
		})
  }

  function removeContext() {
	$(`[id*="dropdown-"]`).each(function() {
		if (!$(this).hasClass('dropdown-menu-context')) {
			$(this).hide()
		}
    })
  }

  function takeDatasetSnapshot(zdataset) {
	  Swal2.fire({
		  title: '<strong>Take Dataset <br>'+zdataset+'</strong> Snapshot',
		  icon: 'question',
		  html: 'This operation will take a Snapshot of the Dataset, are you sure?',
		  input: 'checkbox',
		  inputPlaceholder: 'Recursively create snapshots of all descendent datasets',
		  showConfirmButton: true,
		  confirmButtonText: "Snapshot",
		  showCancelButton: true
	  }).then((result) => {
		  if (result.isConfirmed) {
			  $.post('<?=$urlzmadmin?>',{cmd: 'snapshotdataset', data: zdataset, recursively: result.value}, function(data) {
				  if (data == 'Ok') {
					Swal2.fire({
						title: 'Success!',
						icon: 'success',
						text: 'Snapshot of '+zdataset+' created'
					});
				  } else {
					Swal2.fire({
						title: 'Error!',
						icon: 'error',
						html: 'Unable to take a snapshot of dataset '+zdataset+'<br>Output: '+data
					}); 
				  }
			  });
		  }
	  });
	  $(".swal2-input").attr("type", "mytext");
  }

  function editDataset(zpool, zdataset) {
	  var csrf_token = $("input[name='csrf_token']").val();	 
	  openBox('<?=$urleditdataset?>?zpool='+zpool+'&zdataset='+zdataset+'&csrf_token='+csrf_token, zdataset+" - Edit Dataset",400,400,false);
  }

  function adminDatasetSnaps(zpool, zdataset) {
	  var csrf_token = $("input[name='csrf_token']").val();	 
	  openBox('<?=$urladmindatasetsnaps?>?zpool='+zpool+'&zdataset='+zdataset+'&csrf_token='+csrf_token, zdataset+" - Admin Snapshots",680,680,false);
  }

  function unlockDataset(zdataset) {
	  Swal2.fire({
		  title: '<strong>Passphrase for '+zdataset+'</strong>',
		  input: 'password',
		  inputPlaceholder: 'Enter your Passphrase',
		  inputAttributes: {
			maxlength: 64,
			autocapitalize: 'off',
			autocorrect: 'off'
		  },
		  showConfirmButton: true,
		  showCancelButton: true
	  }).then((result) => {
		  if (result.isConfirmed) {
			  $.post('<?=$urlzmadmin?>',{cmd: 'unlockdataset', data: zdataset, passphrase: result.value}, function(data) {
				  if (data == 'Ok') {
					Swal2.fire({
						title: 'Success!',
						icon: 'success',
						text: 'Dataset '+zdataset+' Unlocked'
					});
				  } else {
					Swal2.fire({
						title: 'Error!',
						icon: 'error',
						html: 'Unable to unlock dataset '+zdataset+'<br>Output: '+data
					}); 
				  }
			  });
		  }
	  });
	  $(".swal2-input").attr("type", "mytext");
  }

  function lockDataset(zdataset) {
	  $.post('<?=$urlzmadmin?>',{cmd: 'lockdataset', data: zdataset},function(data) {
		if (data == 'Ok') {
			Swal2.fire({
				title: 'Success!',
				icon:'success',
				html: zdataset+' Locked!'
			});
		} else {
			Swal2.fire({
				title: 'Error!',
				icon:'error',
				html: 'Lock of '+zdataset+' failed! <br>Output: '+data
			}); 
		}
	  });
  }

  function promoteDataset(zdataset) {
	  $.post('<?=$urlzmadmin?>',{cmd: 'promotedataset', data: zdataset},function(data) {
		if (data == 'Ok') {
			Swal2.fire({
				title: 'Success!',
				icon:'success',
				html: zdataset+' Promoted!'
			});
		} else {
			Swal2.fire({
				title: 'Error!',
				icon:'error',
				html: 'Promotion of '+zdataset+' failed! <br>Output: '+data
			}); 
		}
	  });
  }

  function renameDataset(zdataset) {
	  Swal2.fire({
		  title: '<strong>New name for '+zdataset+'</strong>',
		  html: '<input id="swal2-input" maxlength="256" autocapitalize="off" autocorrect="off" class="swal2-input" placeholder="Dataset new name (Entire name)" value="'+zdataset+'" type="mytext" style="display: flex;">'+
				'<label for="swal2-checkbox" class="swal2-checkbox" style="display: flex;">'+
				'<input type="checkbox" id="swal2-checkbox">'+
				'<span class="swal2-label">Force unmount any file systems that need to be unmounted in the process</span>'+
				'</label>',
		  showConfirmButton: true,
		  showCancelButton: true,
		  preConfirm: function () {
			return new Promise(function (resolve) {
			  if ($('#swal2-input').val() == '') {
				Swal2.showValidationMessage("Enter a value for the dataset name");
				Swal2.enableButtons(); // Enable the confirm button again.
              } else {
				Swal2.resetValidationMessage();
				resolve([
				  $('#swal2-input').val(),
				  $('#swal2-checkbox').attr("checked") ? 1 : 0
				])
			  }
		    })
	      }
	  }).then((result) => {
		  console.log(result);
		  if (result.isConfirmed) {
			$.post('<?=$urlzmadmin?>',{cmd: 'renamedataset', data: zdataset, newname: result.value[0], force: result.value[1]}, function(data) {
			  if (data == 'Ok') {
				Swal2.fire({
				  title: 'Success!',
				  icon: 'success',
				  text: 'Dataset '+zdataset+' renamed'
			    });
			  } else {
				Swal2.fire({
				  title: 'Error!',
				  icon: 'error',
				  html: 'Unable to rename dataset '+zdataset+'<br>Output: '+data
				}); 
			  }
			});
		  }
	  });
	  $(".swal2-html-container").attr("style", "display: grid;");
  }
  
  function destroyDataset(zdataset) {
	  Swal2.fire({
		  title: '<strong>Destroy Dataset<br>'+zdataset+'</strong>',
		  icon: 'warning',
		  html: 'This operation will destroy the Dataset, <b>which cannot be undone</b>, are you sure?',
		  input: 'checkbox',
		  inputPlaceholder: 'Force and Recursively Destroy all Children and Dependents',
		  showConfirmButton: true,
		  confirmButtonText: "Destroy",
		  showCancelButton: true
	  }).then((result) => {
		  if (result.isConfirmed) {
			  $.post('<?=$urlzmadmin?>',{cmd: 'destroydataset', data: zdataset, force: result.value}, function(data) {
				  if (data == 'Ok') {
					Swal2.fire({
						title: 'Success!',
						icon: 'success',
						text: 'Dataset '+zdataset+' destroyed'
					});
				  } else {
					Swal2.fire({
						title: 'Error!',
						icon: 'error',
						html: 'Unable to destroy dataset '+zdataset+'<br>Output: '+data
					}); 
				  }
			  });
		  }
	  });
	  $(".swal2-input").attr("type", "mytext");
  }


</script>
